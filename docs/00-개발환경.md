## 개발환경 세팅

개발 OS : Ubuntu/Debian 계열 리눅스
```

sudo apt update

sudo apt install nasm qemu-system-x86 build-essential git vim

```
## 배경 지식
x86 ISA를 어느 정도 알고 있다고 가정함.
### 모드
- 리얼 모드 : 16비트
- 보호 모드 : 32비트
- IA-32e 모드 : 64비트
BIOS 부팅으로 리얼 모드부터 시작하여, 보호 모드를 거쳐 마지막 IA-32e 모드에서 구동됨.
### 특수한 레지스터들
#### Segment 레지스터
각 세그먼트 당 한 개씩 존재하는 16비트 레지스터로, 어드레스 영역을 다양한 크기로 구분(세그먼테이션)하는 역할을 함.
- 리얼 모드에서 : 단순히 세그먼트의 주소를 가지고 있음.
- 그 외 모드에서 : 해당하는 세그먼트의 GDT(Global Descriptor Table) 오프셋을 저장함. GDT에는 해당하는 디스크립터에 세그먼트의 시작 주소, 접근 권한, 크기가 저장되어 있음.

| 세그먼트 레지스터 이름      | 설명                                                  |
| ----------------- | --------------------------------------------------- |
| CS(Code Segment)  | 코드 영역을 가리키는 레지스터. IP 레지스터(PC 레지스터)에 접근할 때 자동으로 접근됨. |
| DS(Data Segment)  | 데이터 영역을 가리키는 레지스터. 메모리 값에 접근할 때 자동으로 접근됨.           |
| ES(Extra Segment) | 문자열과 관련된 작업을 처리할 때 사용되는 세그먼트를 가리키는 레지스터.            |
| FS, GS            | OS 고유 커스텀 영역을 가리키는 레지스터.                            |
| SS(Stack Segment) | 스택 영역을 가리키는 레지스터.                                   |
#### Control 레지스터

| 컨트롤 레지스터 이름 | 설명                                                  |
| ----------- | --------------------------------------------------- |
| CR0         | 운영 모드를 선택하는 레지스터. 모드 전환과 캐시, 페이징 기능을 활성화 시킴         |
| CR1         | 프로세서에 의해 예약된 레지스터                                   |
| CR2         | 페이지 폴트 발생 시 발생 선형 주소가 저장되는 레지스터.                    |
| CR3         | 페이지 디렉터리의 물리 주소와 페이지 캐시에 관련된 기능을 설정하는 레지스터.         |
| CR4         | 프로세서에서 지원하는 각종 확장 기능을 제어하는 레지스터.                    |
| CR8         | IA-32e 모드에서만 접근 가능하고,  태스크 우선순위 레지스터의 값을 제어하는 레지스터. |

### 운영 모드 별 메모리 관리 기법
#### 리얼 모드
리얼 모드는 최대 1MB까지 주소를 사용함. 세그먼트의 크기는 64K로 고정이고, 세그먼트 레지스터에 세그먼트 시작 주소가 직접 저장됨. 세그먼트의 시작 주소를 기준 주소(Base Address)라고 부름.

리얼 모드에서는 레지스터들의 크기가 16비트이므로, $2^{16}$, 즉 64KB로는 총 1MB의 주소를 포괄할 수 없음. 따라서 세그먼트 레지스터 \* 16 + 범용 레지스터가 물리 주소로 사용됨.

예시 : DS가 0x1000, ax가 0x1234이면, 메모리 접근 관련 물리 주소는 0x11234가 됨.

리얼 모드의 주소 종류들은 다음과 같음.

| 주소 종류 | 설명                                         |
| ----- | ------------------------------------------ |
| 물리 주소 | 실제 메모리 상의 주소.                              |
| 논리 주소 | 실제 코드에 들어가는 주소로, 논리 주소에서 변환을 거쳐야 물리 주소가 됨. |
#### 보호 모드
보호 모드에서는 세그멘테이션과 페이징이 모두 지원됨. 리얼 모드 세그멘테이션과의 결정적 차이는 세그먼트 레지스터에 세그먼트의 기준 주소가 아닌 디스크립터 자료구조의 오프셋이 들어감.

##### 디스크립터
디스크립터는 메모리 영역의 정보를 저장하는 자료구조로, 여러 종류가 있음. 

##### 세그먼트 디스크립터
세그먼트에 대한 정보를 나타내는 디스크립터로, 세그먼트의 시작 어드레스, 크기, 권한, 타입 등의 정보가 들어감.

##### 페이징
보호모드에서는 페이징을 지원함. 따라서 주소 종류들은 다음과 같음.

| 주소 종류 | 설명                                                                                            |
| ----- | --------------------------------------------------------------------------------------------- |
| 물리 주소 | 실제 메모리 상의 주소                                                                                  |
| 논리 주소 | 논리 주소는 실제 코드에 들어가는 주소임                                                                        |
| 선형 주소 | 세그먼테이션을 한번 거친 주소임. 만약 페이징을 지원하면 선형 주소가 한번 더 페이징을 거쳐야 물리 주소가 됨. 지원하지 않는다면 선형 주소가 그대로 물리 주소가 됨. |

#### IA-32e 모드
보호 모드와 같지만 결정적 차이점들이 존재함.
- 세그먼트 디스크립터에 설정된 기준 주소와 크기에 관계없이 모든 세그먼트가 기준 주소는 0, 크기는 64비트 전체로 설정됨 -> 선형 주소를 여러 개의 세그먼트로 구분할 수 없음.
- 세그먼트 디스크립터에 L 필드가 추가됨. 0이면 호환 모드, 1이면 64비트 모드임.